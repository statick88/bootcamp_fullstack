:::{.justify}
# Vistas, Templates y Rutas en Django

En este capítulo, aprenderemos cómo crear vistas, templates y rutas en Django. Las vistas procesan las solicitudes HTTP y devuelven respuestas. Los templates generan la interfaz de usuario, y las rutas definen las URLs para acceder a las vistas.

:::{.callout-tip}
## Modelos y Formularios Reutilizados

- Usaremos los modelos y formularios creados previamente:

### Modelos (models.py):

```python
from django.db import models

class Medicamento(models.Model):
    nombre = models.CharField(max_length=100)
    precio = models.DecimalField(max_digits=10, decimal_places=2)
    existencias = models.IntegerField()
    lugar = models.CharField(max_length=100)
    fecha = models.DateTimeField(auto_now=True)

    def __str__(self):
        return self.nombre  # Devuelve el nombre del medicamento

class Venta(models.Model):
    medicamento = models.ForeignKey(Medicamento, on_delete=models.CASCADE)
    cantidad = models.IntegerField()
    fecha = models.DateTimeField(auto_now=True)

    def __str__(self):
        return f"{self.medicamento.nombre} - {self.cantidad} unidades"  # Muestra el nombre del medicamento y la cantidad vendida
```
### Formularios (forms.py):

```python
from django import forms
from .models import Medicamento, Venta

class MedicamentoForm(forms.ModelForm):
    class Meta:
        model = Medicamento
        fields = ['nombre', 'precio', 'existencias']
```
:::
# Paso 1: Mostrar la Lista de Medicamentos

## Vista

- En **views.py**:

```python
from django.shortcuts import render
from .models import Medicamento

def lista_medicamentos(request):
    medicamentos = Medicamento.objects.all()
    return render(request, 'farmacia/lista_medicamentos.html', {'medicamentos': medicamentos})
```
## Template

- Crea el archivo templates/farmacia/lista_medicamentos.html:

```html
<!DOCTYPE html>
<html>
<head>
    <title>Lista de Medicamentos</title>
</head>
<body>
    <h1>Lista de Medicamentos</h1>
    <a href="{% url 'crear_medicamento' %}">Añadir Medicamento</a>
    <ul>
        {% for medicamento in medicamentos %}
            <li>
                {{ medicamento.nombre }} - ${{ medicamento.precio|floatformat:2 }}
                ({{ medicamento.existencias }} disponibles)
                <a href="{% url 'detalle_medicamento' medicamento.id %}">Detalles</a>
                <a href="{% url 'editar_medicamento' medicamento.id %}">Editar</a>
                <a href="{% url 'eliminar_medicamento' medicamento.id %}">Eliminar</a>
            </li>
        {% endfor %}
    </ul>
</body>
</html>
```
## Ruta

- En **urls.py** de la aplicación **farmacia**:

```python
from django.urls import path
from . import views

urlpatterns = [
    path('medicamentos/', views.lista_medicamentos, name='lista_medicamentos'),
]
```

:::{.callout-tip}
Es necesario conectar las URLs de la aplicación **farmacia** con las URLs del proyecto en **urls.py** del proyecto.

```python
from django.contrib import admin
from django.urls import path, include
from farmacia import urls
urlpatterns = [
    path('admin/', admin.site.urls),
    path('', include('farmacia.urls')),
]
```
:::

# Paso 2: Mostrar el Detalle de un Medicamento

## Vista

- En **views.py**:

```python
from django.shortcuts import get_object_or_404

def detalle_medicamento(request, id):
    medicamento = get_object_or_404(Medicamento, id=id)
    return render(request, 'farmacia/detalle_medicamento.html', {'medicamento': medicamento})
```
## Template

- Crea el archivo **templates/farmacia/detalle_medicamento.html**:

```html
<!DOCTYPE html>
<html>
<head>
    <title>Detalle del Medicamento</title>
</head>
<body>
    <h1>{{ medicamento.nombre }}</h1>
    <p><strong>Precio:</strong> ${{ medicamento.precio }}</p>
    <p><strong>Existencias:</strong> {{ medicamento.existencias }}</p>
    <a href="{% url 'lista_medicamentos' %}">Volver a la lista</a>
</body>
</html>
```
## Ruta

- Agrega la ruta en **urls.py**:

```python
path('medicamentos/<int:id>/', views.detalle_medicamento, name='detalle_medicamento'),
```

# Paso 3: Crear un Nuevo Medicamento

## Vista

- En **views.py**:

```python
from django.shortcuts import redirect
from .forms import MedicamentoForm

def crear_medicamento(request):
    if request.method == 'POST':
        form = MedicamentoForm(request.POST)
        if form.is_valid():
            form.save()
            return redirect('lista_medicamentos')
    else:
        form = MedicamentoForm()
    return render(request, 'farmacia/crear_medicamento.html', {'form': form})
```
## Template

- Crea **templates/farmacia/crear_medicamento.html**:

```html
<!DOCTYPE html>
<html>
<head>
    <title>Crear Medicamento</title>
</head>
<body>
    <h1>Crear Medicamento</h1>
    <form method="post">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit">Guardar</button>
    </form>
    <a href="{% url 'lista_medicamentos' %}">Volver a la lista</a>
</body>
</html>
```
## Ruta

- Agrega la ruta en **urls.py**:

```python
path('medicamentos/nuevo/', views.crear_medicamento, name='crear_medicamento'),
```

# Paso 4. Editar un Medicamento

## Vista

- En **views.py**:

```python
def editar_medicamento(request, id):
    medicamento = get_object_or_404(Medicamento, id=id)
    if request.method == 'POST':
        form = MedicamentoForm(request.POST, instance=medicamento)
        if form.is_valid():
            form.save()
            return redirect('lista_medicamentos')
    else:
        form = MedicamentoForm(instance=medicamento)
    return render(request, 'farmacia/editar_medicamento.html', {'form': form})
```

## Template

- Crea **templates/farmacia/editar_medicamento.html**:

```html
<!DOCTYPE html>
<html>
<head>
    <title>Editar Medicamento</title>
</head>
<body>
    <h1>Editar Medicamento</h1>
    <form method="post">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit">Guardar</button>
    </form>
    <a href="{% url 'lista_medicamentos' %}">Volver a la lista</a>
</body>
</html>
```

## Ruta

- Agrega la ruta en **urls.py**:

```python
path('medicamentos/editar/<int:id>/', views.editar_medicamento, name='editar_medicamento'),
```

# Paso 5. Eliminar un Medicamento

## Vista

- En **views.py**:

```python
def eliminar_medicamento(request, id):
    medicamento = get_object_or_404(Medicamento, id=id)
    medicamento.delete()
    return redirect('lista_medicamentos')
```

## Template

- No se necesita un template para esta vista.

## Ruta

- Agrega la ruta en **urls.py**:

```python
path('medicamentos/eliminar/<int:id>/', views.eliminar_medicamento, name='eliminar_medicamento'),
```

## Probar las Vistas

- Inicia el **servidor**:

```bash
python manage.py runserver
```
Navega a:

- **Lista de Medicamentos**: <http://localhost:8000/medicamentos/>
- **Detalle de Medicamento**: <http://localhost:8000/medicamentos/1/> (reemplaza 1 por un ID válido).
- **Crear Medicamento**: <http://localhost:8000/medicamentos/nuevo/>.
- **Editar Medicamento**: <http://localhost:8000/medicamentos/editar/1/> (reemplaza 1 por un ID válido).
- **Eliminar Medicamento**: <http://localhost:8000/medicamentos/eliminar/1/> (reemplaza 1 por un ID válido).
:::
